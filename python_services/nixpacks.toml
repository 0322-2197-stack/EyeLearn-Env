# Nixpacks configuration for Python Eye Tracking Service (FastAPI)
# This configures the build environment for Railway deployment

[variables]
# Disable server-side camera (Railway has no camera hardware)
CAMERA_ENABLED = "false"

[phases.setup]
# Install system dependencies required by OpenCV
nixPkgs = [
  "python312",
  "libGL",
  "libglvnd",
  "glib", 
  "gcc"
]
# Create the virtual environment early so later phases can rely on it
cmds = [
  "python3 -m venv /opt/venv",
  "/opt/venv/bin/pip install --upgrade pip"
]

[phases.install]
dependsOn = ["setup"]
cmds = [
  "/opt/venv/bin/pip install --no-cache-dir -r requirements.txt"
]

[start]
# Set LD_LIBRARY_PATH at runtime and start FastAPI
cmd = "LD_LIBRARY_PATH=/nix/store/*-libglvnd-*/lib:/nix/store/*-glib-*/lib:/nix/store/*-gcc-*/lib:$LD_LIBRARY_PATH /opt/venv/bin/python -m uvicorn fastapi_service:app --host 0.0.0.0 --port $PORT --workers 1"
